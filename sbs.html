<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0f4f8, #e2e8f0);
      color: #333;
    }
    header {
      padding: 1rem;
      background: linear-gradient(90deg, #2563eb, #1e3a8a);
      color: #fff;
      text-align: center;
      font-size: 1.6rem;
      font-weight: bold;
      letter-spacing: 1px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      animation: fadeDown 1s ease;
    }
    @keyframes fadeDown {
      from {opacity: 0; transform: translateY(-20px);} to {opacity: 1; transform: translateY(0);}
    }
    .container { max-width: 1200px; margin: auto; padding: 1rem; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .card { background: #fff; border-radius: 12px; padding: 0.8rem; box-shadow: 0 3px 8px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; animation: fadeUp 1s ease; }
    .card:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
    .card h3 { margin: 0; color: #2563eb; font-size: 1rem; }
    .card p { margin: 0.4rem 0 0; font-size: 1.1rem; font-weight: bold; color: #111827; }
    @keyframes fadeUp { from {opacity: 0; transform: translateY(20px);} to {opacity: 1; transform: translateY(0);} }
    .filters { display: flex; flex-wrap: wrap; gap: 0.6rem; margin-bottom: 1.5rem; align-items: center; animation: fadeUp 1.2s ease; }
    .filters input, .filters button { padding: 0.4rem 0.8rem; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 0.9rem; }
    .filters input { background: #f8fafc; transition: border 0.3s ease; }
    .filters input:focus { border: 1px solid #2563eb; outline: none; }
    .filters button { background: #2563eb; color: #fff; border: none; cursor: pointer; transition: background 0.3s ease, transform 0.2s ease; }
    .filters button:hover { background: #1d4ed8; transform: translateY(-2px); }
    .status { font-size: 0.9rem; font-weight: bold; margin-left: 1rem; padding: 0.2rem 0.6rem; border-radius: 6px; color: #fff; }
    .status.connected { background: #16a34a; }
    .status.disconnected { background: #dc2626; }
    canvas { background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 0.6rem; animation: fadeUp 1.5s ease; }
  </style>
</head>
<body>
  <header>SBS</header>

  <div class="container">
    <div class="cards">
      <div class="card"><h3>Balance</h3><p id="balance"></p></div>
      <div class="card"><h3>Profit</h3><p id="profit"></p></div>
      <div class="card"><h3>Running</h3><p id="running"></p></div>
      <div class="card"><h3>Markup</h3><p id="markup"></p></div>
      <div class="card"><h3>Transactions</h3><p id="transactions"></p></div>
      <div class="card"><h3>Trades</h3><p  id="count"></p></div>
      <div class="card"><h3>Win Rate</h3><p id="rate"></p></div>
    </div>

    <div class="filters">
      <label>From: <input id="fromInput" type="text" placeholder="dd-mm-yyyy hh:mm"></label>
      <label>To: <input id="toInput" type="text" placeholder="dd-mm-yyyy hh:mm"></label>
      <button id="loadBtn">Load</button>
      <button id="connectBtn">Connect</button>
      <span id="wsStatus" class="status disconnected">Disconnected</span>
    </div>

    <canvas id="barChart"></canvas>
  </div>

  <script>
    const token = "4SPwnIvTNnbKZJU";
    const TZ = 'Africa/Harare'; // fixed timezone (UTC+2, no DST)

    const wsStatus = document.getElementById('wsStatus');
    const connectBtn = document.getElementById('connectBtn');

    // Use Zimbabwean local time strings (yyyy-mm-dd hh:mm)
    var date_from = "2024-01-01 00:00:00";
    var date_to   = "2090-01-01 00:00:00";

    var total_balance = 0;
    var total_stake = 0;
    var total_running = 0;
    var total_profit = 0;

    let chart;
    const ctx = document.getElementById('barChart').getContext('2d');
    let months = [];
    let values = [];
    let pendingMonths = [];

    let ws;

    function connectWS() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        console.log("Already connected");
        return;
      }
      ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=97811');

      ws.onopen = () => {
        console.log('WebSocket connected');
        wsStatus.textContent = 'Connected';
        wsStatus.classList.remove('disconnected');
        wsStatus.classList.add('connected');

        total_balance = 0;
        total_stake = 0;
        total_running = 0;
        total_profit = 0;
        months = [];
        values = [];
        pendingMonths = [];

        authorize();
      };

      ws.onmessage = (msg) => {
        let ms = JSON.parse(msg.data);
        let req = ms.echo_req || {};
        var req_id = req.req_id;

        var error = ms.error;
        if (error) {
            alert(error.message || JSON.stringify(error));
            console.log(ms);
        } else {
            if (req_id === 1111) {
                theBalance();
                markUp();
                openContracts();
                profitTable();
                fetchLast12Months();
            }
            if (req_id === 1000) {
                const b = ms.balance;
                const balance = b.balance;
                const currency = b.currency;
                total_balance = total_stake + balance;
                document.getElementById('balance').textContent = total_balance.toFixed(2) + ' ' + currency;
            }
            if (req_id === 1005) {
                const con = ms.profit_table;
                const trans = con.transactions || [];
                const count = con.count || 0;
                var won = 0;
                for (var i = 0; i < trans.length; i++) {
                    var a = trans[i];
                    var buy_price = a.buy_price;
                    var sell_price = a.sell_price;
                    var pro = sell_price - buy_price;
                    total_profit += pro;
                    if (pro > 0) { won ++; }
                }
                document.getElementById('profit').textContent = '$' + total_profit.toFixed(2);
                const rate = count ? (won * 100 / count) : 0;
                document.getElementById('rate').textContent = rate.toFixed(0) + '%';
                document.getElementById('count').textContent = count;
            }
            if (req_id === 1006) {
                const app = ms.app_markup_statistics || {};
                const total = app.total_app_markup_usd || 0;
                const trans = app.total_transactions_count || 0;
                document.getElementById('markup').textContent = '$' + Number(total).toFixed(2);
                document.getElementById('transactions').textContent = trans;
            }
            if (req_id === 1007) {
              const open = ms.proposal_open_contract || {};
              const stake = open.buy_price || 0;
              const currency = open.currency || '';
              const bid_price = open.bid_price || 0;
              total_running += bid_price;
              total_stake += stake;
              total_balance += stake;
              document.getElementById('balance').textContent = total_balance.toFixed(2) + ' ' + currency;
              document.getElementById('running').textContent = total_running.toFixed(2) + ' ' + currency;
            }
            if (req_id === 1008) {
                const app = ms.app_markup_statistics || {};
                var total = app.total_app_markup_usd || 0;
                values.push(Number(total).toFixed(0));
                requestNextMonth();
            }
        }
      };

      ws.onerror = (err) => { console.error('WebSocket error:', err); };
      ws.onclose = () => {
        console.log('WebSocket closed');
        wsStatus.textContent = 'Disconnected';
        wsStatus.classList.remove('connected');
        wsStatus.classList.add('disconnected');
      };
    }

    connectWS();
    connectBtn.addEventListener('click', connectWS);

    function authorize() {
        const msg = JSON.stringify({ authorize: token, req_id: 1111 });
        if (ws.readyState === WebSocket.OPEN) { ws.send(msg); }
    }

    function theBalance() {
        const msg = JSON.stringify({ balance: 1, subscribe: 0, req_id: 1000 });
        if (ws.readyState === WebSocket.OPEN) { ws.send(msg); }
    }

    function profitTable() {
        const msg = JSON.stringify({
            profit_table: 1,
            description: 1,
            contract_type: ['MULTUP', 'MULTDOWN'],
            sort: 'DESC',
            date_from: date_from.split(" ")[0],
            date_to: date_to.split(" ")[0], 
            limit: 500,
            req_id: 1005,
        });
        if (ws.readyState === WebSocket.OPEN) { ws.send(msg); }
    }

    function markUp() {
        const msg = JSON.stringify({
            app_markup_statistics: 1,
            date_from: date_from, // Zimbabwe time string
            date_to: date_to,     // Zimbabwe time string
            req_id: 1006,
        });
        if (ws.readyState === WebSocket.OPEN) { ws.send(msg); }
    }

    function openContracts() {
        const msg = JSON.stringify({ proposal_open_contract: 1, req_id: 1007 });
        if (ws.readyState === WebSocket.OPEN) { ws.send(msg); }
    }

    // ---------- Zimbabwe-time monthly builder ----------
    const MONTHS_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    function pad2(n){ return n < 10 ? '0' + n : '' + n; }
    function addMonths(year, month1to12, delta){
      let m0 = month1to12 - 1 + delta; // 0..11 space
      let y = year + Math.floor(m0 / 12);
      let m = (m0 % 12 + 12) % 12; // normalize to 0..11
      return { y, m: m + 1 };
    }
    function getHarareYearMonthNow(){
      const parts = new Intl.DateTimeFormat('en-GB', { timeZone: TZ, year: 'numeric', month: '2-digit' }).formatToParts(new Date());
      const y = parseInt(parts.find(p => p.type === 'year').value, 10);
      const m = parseInt(parts.find(p => p.type === 'month').value, 10);
      return { y, m };
    }

    function fetchLast12Months(){
      const nowHM = getHarareYearMonthNow();
      for(let i = 11; i >= 0; i--){
        const ym = addMonths(nowHM.y, nowHM.m, -i);
        const next = addMonths(ym.y, ym.m, 1);
        const from = `${ym.y}-${pad2(ym.m)}-01 00:00:00`;      // Zimbabwe local start
        const to   = `${next.y}-${pad2(next.m)}-01 00:00:00`;  // Zimbabwe local end (first of next month)
        pendingMonths.push({ label: `${MONTHS_SHORT[ym.m-1]} ${String(ym.y).slice(-2)}`, from, to });
      }
      requestNextMonth();
    }

    function requestNextMonth(){
      if (pendingMonths.length === 0){
        updateChart(months, values);
        return;
      }
      const { label, from, to } = pendingMonths.shift();
      ws.send(JSON.stringify({ app_markup_statistics: 1, date_from: from, date_to: to, req_id: 1008 }));
      months.push(label);
    }
    // ---------------------------------------------------

    function updateChart(months, values) {
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Monthly Value',
            data: values,
            backgroundColor: 'rgba(37, 99, 235, 0.8)',
            borderRadius: 6,
            hoverBackgroundColor: 'rgba(29, 78, 216, 0.9)'
          }]
        },
        options: {
          responsive: true,
          layout: { padding: { top: 40 } }, // extra top padding so labels fit
          plugins: {
            legend: { display: false },
            datalabels: {
              anchor: 'end',
              align: 'top',
              clamp: true,
              clip: false,
              color: '#111827',
              font: { weight: 'bold' },
              formatter: (val) => val
            }
          },
          scales: { y: { display: false, beginAtZero: true } }
        },
        plugins: [ChartDataLabels]
      });
    }
  </script>
</body>
</html>
